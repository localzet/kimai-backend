datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  password String
  tokenVersion Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  settings   UserSettings?
  timesheets Timesheet[]
  syncState  SyncState?
  sessions   Session[]
  mlResults  MlResult[]
}

model UserSettings {
  id              String   @id @default(uuid())
  userId          String   @unique
  kimaiApiUrl     String
  kimaiApiKey     String
  ratePerMinute   Float    @default(0)
  projectSettings Json
  excludedTags    String[] @default([])
  calendarSync    Json?
  userPreferences Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model SyncState {
  id         String @id @default(uuid())
  userId     String @unique
  syncStatus String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model Timesheet {
  id           String    @id @default(uuid())
  userId       String
  kimaiId      Int?
  begin        DateTime
  end          DateTime?
  duration     Int?
  projectId    Int?
  projectName  String?
  activityId   Int?
  activityName String?
  description  String?
  tags         String[]  @default([])
  metaFields   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, kimaiId])
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  refreshToken String   @unique
  expiresAt    DateTime
  lastUsedAt   DateTime
  ipAddress    String?
  userAgent    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model MlConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MlResult {
  id          String  @id @default(uuid())
  userId      String?
  timesheetId String?
  kind        String // e.g., "forecasting", "anomaly", "recommendation"
  payload     Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id])
}
